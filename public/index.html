<!doctype html>
<html>
  <head>
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Socket.IO Chat</title>
    <style>
      body {
        margin: 0;
        padding-bottom: 3rem;
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica,
          Arial, sans-serif;
      }
      #form {
        background: rgba(0, 0, 0, 0.15);
        padding: 0.25rem;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        display: flex;
        height: 3rem;
        box-sizing: border-box;
        backdrop-filter: blur(10px);
      }
      #input {
        border: none;
        padding: 0 1rem;
        flex-grow: 1;
        border-radius: 2rem;
        margin: 0.25rem;
      }
      #input:focus {
        outline: none;
      }
      #form > button {
        background: #333;
        border: none;
        padding: 0 1rem;
        margin: 0.25rem;
        border-radius: 3px;
        outline: none;
        color: #fff;
      }
      #messages {
        list-style-type: none;
        margin: 0;
        padding: 0;
      }
      #messages > li {
        padding: 0.5rem 1rem;
      }
      #messages > li:nth-child(odd) {
        background: lightgray;
        box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      }
      #controls {
        padding: 0.5rem;
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      #controls > * {
        font-size: 1rem;
      }

      #controls button {
        padding: 0 1rem;
        border: none;
        border-radius: 3px;
        background: #333;
        color: white;
        cursor: pointer;
      }
      #controls button:hover {
        background: #555;
      }
      #controls input,
      #controls select {
        padding: 0.25rem 0.5rem;
        border: 1px solid #ccc;
        border-radius: 3px;
      }

      .message {
        display: flex;
        align-items: flex-start;
        margin: 8px 0;
      }

      .avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        margin-right: 10px;
      }

      .message-content {
        background: #f2f2f2;
        padding: 8px 12px;
        border-radius: 12px;
        max-width: 70%;
      }
    </style>
  </head>
  <body>
    <div id="controls">
      <!-- Nickname -->
      <input id="nickname" placeholder="Enter nickname" />
      <button id="setNicknameBtn">Set Nickname</button>

      <!-- Room -->
      <select id="room">
        <option value="general">General</option>
        <option value="football">Football</option>
        <option value="programming">Programming</option>
      </select>
      <button id="joinRoomBtn">Join Room</button>
    </div>

    <!-- Messages -->
    <ul id="messages"></ul>

    <div
      id="typingIndicator"
      style="padding: 0 1rem; color: gray; font-style: italic"
    ></div>

    <!-- Chat input -->
    <form id="form" action="">
      <input id="input" autocomplete="off" placeholder="Type a message..." />
      <button>Send</button>
    </form>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      let counter = 0;
      let nicknameSet = false;
      let typingTimeout;

      const socket = io({auth: {serverOffset: 0}});

      const form = document.getElementById('form');
      const input = document.getElementById('input');
      const messages = document.getElementById('messages');
      const typingIndicator = document.getElementById('typingIndicator');

      // --- Set nickname
      document
        .getElementById('setNicknameBtn')
        .addEventListener('click', () => {
          const nickname = document.getElementById('nickname').value.trim();
          if (!nickname) return;
          socket.emit('set nickname', nickname, () => {
            nicknameSet = true;
            document.getElementById('nickname').style.display = 'none';
            document.getElementById('setNicknameBtn').style.display = 'none';
          });
        });

      // --- Join room
      document.getElementById('joinRoomBtn').addEventListener('click', () => {
        const room = document.getElementById('room').value;
        if (!nicknameSet) return;
        messages.innerHTML = ''; // clear old messages
        socket.emit('join room', room);
      });

      // --- Send message
      form.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!nicknameSet || !input.value.trim()) return;

        const clientOffset = `${socket.id}-${counter++}`;
        socket.emit('chat message', input.value.trim(), clientOffset, (err) => {
          if (!err) input.value = '';
        });
      });

      // --- Typing events
      input.addEventListener('input', () => {
        socket.emit('typing');
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit('stop typing');
        }, 1000); // stop typing after 1s of inactivity
      });

      // --- Receive chat messages
      socket.on('chat message', (msg, serverOffset) => {
        const item = document.createElement('li');
        item.classList.add('message');

        const avatarUrl = `https://robohash.org/${encodeURIComponent(msg.nickname)}.png?size=40x40`;

        item.innerHTML = `
          <img src="${avatarUrl}" alt="${msg.nickname}" class="avatar">
          <div class="message-content">
            <strong>${msg.nickname}</strong><br>
            ${msg.text}
          </div>
        `;

        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
        socket.auth.serverOffset = serverOffset;
      });

      // --- Receive system messages
      socket.on('system message', (msg) => {
        const item = document.createElement('li');
        item.textContent = `[SYSTEM] ${msg}`;
        item.style.fontStyle = 'italic';
        item.style.color = 'gray';
        messages.appendChild(item);
        window.scrollTo(0, document.body.scrollHeight);
      });

      // --- Show who is typing
      socket.on('user typing', (nickname) => {
        typingIndicator.textContent = `${nickname} is writing...`;
      });

      socket.on('user stop typing', () => {
        typingIndicator.textContent = '';
      });
    </script>
  </body>
</html>
